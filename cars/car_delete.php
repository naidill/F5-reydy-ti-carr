<?php
session_start();
// р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕ер╣Зр╕нр╕Бр╕нр╕┤р╕Щр╕Вр╕нр╕З Admin
if (!isset($_SESSION['loggedin']) || $_SESSION['loggedin'] !== true) {
    header('Location: ../login.php'); // р╕вр╣Йр╕нр╕Щр╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕лр╕Щр╣Йр╕▓р╕ер╣Зр╕нр╕Бр╕нр╕┤р╕Щ Admin
    exit;
}

// Path р╕Вр╕нр╕З config.php р╕Хр╣Йр╕нр╕Зр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З: р╣Др╕Яр╕ер╣Мр╕Щр╕╡р╣Йр╕нр╕вр╕╣р╣Ир╣Гр╕Щ cars/ р╕Фр╕▒р╕Зр╕Щр╕▒р╣Йр╕Щр╕Хр╣Йр╕нр╕Зр╕вр╣Йр╕нр╕Щр╕Бр╕ер╕▒р╕Ър╣Др╕Ы 1 р╕гр╕░р╕Фр╕▒р╕Ъ
require '../config.php'; 

$error = '';

if (isset($_GET['id'])) {
    $car_id = filter_var($_GET['id'], FILTER_VALIDATE_INT);

    if ($car_id === false) {
        $error = "р╕гр╕лр╕▒р╕кр╕гр╕Цр╕вр╕Щр╕Хр╣Мр╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З";
    } else {
        try {
            // р╕Фр╕╢р╕Зр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╕гр╕Цр╕вр╕Щр╕Хр╣Мр╕Бр╣Ир╕нр╕Щр╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕Кр╣Йр╣Гр╕Щр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ
            $stmt_car = $pdo->prepare("SELECT license_plate FROM cars WHERE car_id = ?");
            $stmt_car->execute([$car_id]);
            $car_info = $stmt_car->fetch();
            
            if (!$car_info) {
                $error = "р╣Др╕бр╣Ир╕Юр╕Ър╕гр╕Цр╕вр╕Щр╕Хр╣Мр╕гр╕лр╕▒р╕к #{$car_id} р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕ер╕Ъ";
            } else {
                
                // 1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕гр╕Цр╕вр╕Щр╕Хр╣Мр╕бр╕╡р╕гр╕▓р╕вр╕Бр╕▓р╕гр╣Ар╕Кр╣Ир╕▓р╕Чр╕╡р╣Ир╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
                $stmt_check_rentals = $pdo->prepare("SELECT COUNT(*) FROM rentals WHERE car_id = ?");
                $stmt_check_rentals->execute([$car_id]);
                $rental_count = $stmt_check_rentals->fetchColumn();

                if ($rental_count > 0) {
                    // ЁЯЪи р╕лр╣Йр╕▓р╕бр╕ер╕Ър╕лр╕▓р╕Бр╕бр╕╡р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╣Ар╕Кр╣Ир╕▓
                    $error = "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕ер╕Ър╕гр╕Цр╕вр╕Щр╕Хр╣Мр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щ **{$car_info['license_plate']}** р╣Др╕Фр╣Й р╣Ар╕Щр╕╖р╣Ир╕нр╕Зр╕Ир╕▓р╕Бр╕бр╕╡р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╣Ар╕Кр╣Ир╕▓ ({$rental_count} р╕гр╕▓р╕вр╕Бр╕▓р╕г) р╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕Зр╕нр╕вр╕╣р╣И. р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕кр╕Цр╕▓р╕Щр╕░р╣Ар╕Ыр╣Зр╕Щ 'Maintenance' р╕лр╕гр╕╖р╕н 'Retired' р╣Бр╕Чр╕Щр╕Бр╕▓р╕гр╕ер╕Ъ.";
                    
                } else {
                    // 2. р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕бр╕╡р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╣Ар╕Кр╣Ир╕▓: р╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕ер╕Ъ
                    $stmt_delete = $pdo->prepare("DELETE FROM cars WHERE car_id = ?");
                    $stmt_delete->execute([$car_id]);
                    
                    // р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Др╕зр╕▓р╕бр╕кр╕│р╣Ар╕гр╣Зр╕Ир╣Бр╕ер╕░ Redirect
                    $_SESSION['message'] = "тЬЕ р╕гр╕Цр╕вр╕Щр╕Хр╣Мр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щ **{$car_info['license_plate']}** р╕Цр╕╣р╕Бр╕ер╕Ър╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ър╣Бр╕ер╣Йр╕з";
                    $_SESSION['alert_type'] = 'success';
                }
            }

        } catch (PDOException $e) {
            // р╕Фр╕▒р╕Бр╕Ир╕▒р╕Ър╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╕Чр╕▒р╣Ир╕зр╣Др╕Ы (р╕гр╕зр╕бр╕Цр╕╢р╕З Foreign Key р╕лр╕▓р╕Бр╣Вр╕Др╣Йр╕Фр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Др╕бр╣Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М)
            $error = "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е: " . $e->getMessage();
        }
    }
} else {
    $error = "р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕гр╕лр╕▒р╕кр╕гр╕Цр╕вр╕Щр╕Хр╣Мр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕ер╕Ъ";
}

// р╕лр╕▓р╕Бр╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф р╣Гр╕лр╣Йр╕нр╕▒р╕Ыр╣Ар╕Фр╕Х Session
if ($error) {
    $_SESSION['message'] = "тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф: {$error}";
    $_SESSION['alert_type'] = 'danger';
}

// Redirect р╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕лр╕Щр╣Йр╕▓р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕гр╕Цр╕вр╕Щр╕Хр╣М
header('Location: ../cars.php');
exit;
?>